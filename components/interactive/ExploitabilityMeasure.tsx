"use client";

import { useState } from "react";
import { motion } from "framer-motion";

export function ExploitabilityMeasure() {
    const [strategy, setStrategy] = useState([0.33, 0.33, 0.34]);  // Rock, Paper, Scissors
    const nashStrategy = [1 / 3, 1 / 3, 1 / 3];

    // Payoff matrix for RPS (row player)
    const payoff = [
        [0, -1, 1],
        [1, 0, -1],
        [-1, 1, 0]
    ];

    // Compute best response
    const expectedPayoffs = payoff.map(row =>
        row.reduce((sum, val, i) => sum + val * strategy[i], 0)
    );
    const bestResponseValue = Math.max(...expectedPayoffs);
    const bestResponseIdx = expectedPayoffs.indexOf(bestResponseValue);

    // Nash value (against uniform)
    const nashValue = strategy.reduce((sum, prob, i) =>
        sum + prob * payoff[i].reduce((s, v, j) => s + v * nashStrategy[j], 0)
        , 0);

    const exploitability = bestResponseValue - nashValue;

    const actions = ["Rock", "Paper", "Scissors"];

    return (
        <div className="w-full max-w-5xl mx-auto p-6 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-slate-900 dark:to-purple-950 rounded-2xl shadow-xl">
            <div className="text-center mb-6">
                <h3 className="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-2">
                    Exploitability Measure
                </h3>
                <p className="text-sm text-slate-600 dark:text-slate-400">
                    Adjust strategy to see how far from Nash equilibrium
                </p>
            </div>

            {/* Strategy Controls */}
            <div className="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-lg mb-6">
                <h4 className="text-lg font-bold mb-4">Your Strategy (Rock-Paper-Scissors)</h4>
                <div className="space-y-4">
                    {actions.map((action, idx) => {
                        const diff = strategy[idx] - nashStrategy[idx];
                        const deviation = (diff * 100).toFixed(1);

                        return (
                            <div key={action}>
                                <div className="flex justify-between text-sm mb-2">
                                    <span className="font-semibold">{action}</span>
                                    <div className="flex gap-2 items-center">
                                        <span className="text-slate-600 dark:text-slate-400">
                                            {(strategy[idx] * 100).toFixed(1)}%
                                        </span>
                                        <span className={`text-xs ${Math.abs(diff) < 0.01 ? "text-green-600" :
                                            diff > 0 ? "text-red-600" : "text-blue-600"
                                            }`}>
                                            ({diff > 0 ? "+" : ""}{deviation}% from Nash)
                                        </span>
                                    </div>
                                </div>
                                <input
                                    type="range"
                                    min="0"
                                    max="100"
                                    value={strategy[idx] * 100}
                                    onChange={(e) => {
                                        const newVal = parseInt(e.target.value) / 100;
                                        const newStrategy = [...strategy];
                                        newStrategy[idx] = newVal;

                                        // Normalize
                                        const sum = newStrategy.reduce((a, b) => a + b, 0);
                                        if (sum > 0) {
                                            newStrategy.forEach((_, i) => newStrategy[i] /= sum);
                                        }

                                        setStrategy(newStrategy);
                                    }}
                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                />
                                <div className="h-6 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mt-2">
                                    <div
                                        className={`h-full ${idx === 0 ? "bg-red-500" :
                                            idx === 1 ? "bg-blue-500" : "bg-green-500"
                                            }`}
                                        style={{ width: `${strategy[idx] * 100}%` }}
                                    />
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Best Response */}
            <div className="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-lg mb-6">
                <h4 className="text-lg font-bold mb-4">Best Response Analysis</h4>
                <div className="grid grid-cols-3 gap-4 mb-4">
                    {actions.map((action, idx) => (
                        <div
                            key={action}
                            className={`p-4 rounded-lg border-2 ${idx === bestResponseIdx
                                ? "bg-orange-100 dark:bg-orange-900/30 border-orange-500"
                                : "bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-700"
                                }`}
                        >
                            <div className="font-semibold text-sm mb-1">{action}</div>
                            <div className="text-xl font-mono">{expectedPayoffs[idx].toFixed(3)}</div>
                            {idx === bestResponseIdx && (
                                <div className="text-xs text-orange-600 dark:text-orange-400 mt-1">
                                    â˜… Best Response
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>

            {/* Exploitability Metric */}
            <div className={`p-6 rounded-xl shadow-lg ${exploitability < 0.01
                ? "bg-green-100 dark:bg-green-900/30 border-2 border-green-500"
                : exploitability < 0.1
                    ? "bg-yellow-100 dark:bg-yellow-900/30 border-2 border-yellow-500"
                    : "bg-red-100 dark:bg-red-900/30 border-2 border-red-500"
                }`}>
                <h4 className="text-lg font-bold mb-3">Exploitability</h4>
                <div className="grid grid-cols-3 gap-4">
                    <div className="text-center">
                        <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Best Response Value</div>
                        <div className="text-3xl font-bold">{bestResponseValue.toFixed(3)}</div>
                    </div>
                    <div className="text-center">
                        <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Nash Value</div>
                        <div className="text-3xl font-bold">{nashValue.toFixed(3)}</div>
                    </div>
                    <div className="text-center">
                        <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Exploitability</div>
                        <div className={`text-4xl font-bold ${exploitability < 0.01 ? "text-green-600" :
                            exploitability < 0.1 ? "text-yellow-600" : "text-red-600"
                            }`}>
                            {exploitability.toFixed(3)}
                        </div>
                    </div>
                </div>

                <div className="mt-4 h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div
                        className={`h-full ${exploitability < 0.01 ? "bg-green-500" :
                            exploitability < 0.1 ? "bg-yellow-500" : "bg-red-500"
                            }`}
                        style={{ width: `${Math.min(100, exploitability * 100)}%` }}
                    />
                </div>

                {exploitability < 0.01 ? (
                    <div className="mt-3 text-center text-green-700 dark:text-green-400 font-semibold">
                        âœ“ Near Nash Equilibrium!
                    </div>
                ) : (
                    <div className="mt-3 text-center text-red-700 dark:text-red-400 font-semibold">
                        âš  Highly exploitable - opponent can abuse this strategy
                    </div>
                )}
            </div>

            <div className="mt-6 text-center text-sm text-slate-600 dark:text-slate-400">
                ðŸ’¡ Lower exploitability = harder for opponents to take advantage
            </div>
        </div>
    );
}
